<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crohn's Food Log</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    input[type="text"],
    button {
      font-size: 1rem;
      padding: 6px;
    }
    .symptom-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 20px;
    }
    .symptom-list label {
      flex: 0 0 200px;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }
    th,
    td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>Crohn's Food Log</h1>

  <label>Ingredients (comma-separated):</label><br />
  <input type="text" id="ingredients" size="80" /><br /><br />

  <label>Select Symptoms Experienced:</label>
  <div class="symptom-list" id="symptomChecklist">
    <!-- Symptoms generated by JS -->
  </div>

  <button onclick="addEntry()">Add Entry</button>
  <button onclick="downloadResults()">Download Results</button>

  <table id="resultsTable" style="display: none;">
    <thead>
      <tr>
        <th>Ingredient</th>
        <th>Associated Symptoms</th>
        <th>Risk Level</th>
        <!-- Hidden column header for symptom rate -->
        <th style="display: none;">Symptom Rate (Decimal)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const crohnsSymptoms = [
      "Abdominal pain",
      "Diarrhea",
      "Fatigue",
      "Bloating",
      "Joint pain",
      "Mouth sores",
      "Fever",
      "Constipation",
      "Nausea",
    ];

    const entries = [];

    function createSymptomChecklist() {
      const container = document.getElementById("symptomChecklist");
      crohnsSymptoms.forEach((symptom) => {
        const label = document.createElement("label");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = symptom;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(" " + symptom));
        container.appendChild(label);
      });
    }

    function getCheckedSymptoms() {
      return Array.from(
        document.querySelectorAll("#symptomChecklist input[type='checkbox']")
      )
        .filter((cb) => cb.checked)
        .map((cb) => cb.value);
    }

    function clearChecklist() {
      document
        .querySelectorAll("#symptomChecklist input[type='checkbox']")
        .forEach((cb) => (cb.checked = false));
    }

    function parseList(str) {
      return str
        .split(",")
        .map((s) => s.trim().toLowerCase())
        .filter((s) => s);
    }

    function addEntry() {
      const ingredients = parseList(
        document.getElementById("ingredients").value
      );
      const symptoms = getCheckedSymptoms();

      if (ingredients.length === 0) {
        alert("Please enter at least one ingredient.");
        return;
      }

      entries.push({ meal: ingredients, symptoms: symptoms.map((s) => s.toLowerCase()) });
      document.getElementById("ingredients").value = "";
      clearChecklist();
      // Removed alert here
      analyze(); // Auto analyze here
    }

    function analyze() {
      const ingredientData = {};

      entries.forEach((entry) => {
        const hasSymptoms = entry.symptoms.length > 0;
        entry.meal.forEach((ingredient) => {
          if (!ingredientData[ingredient]) {
            ingredientData[ingredient] = {
              total: 0,
              symptomCount: 0,
              symptoms: new Set(),
            };
          }
          ingredientData[ingredient].total++;
          if (hasSymptoms) {
            ingredientData[ingredient].symptomCount++;
            entry.symptoms.forEach((sym) => ingredientData[ingredient].symptoms.add(sym));
          }
        });
      });

      const results = [];

      for (const ingredient in ingredientData) {
        const data = ingredientData[ingredient];
        const rate = data.symptomCount / data.total;
        let risk;
        if (data.symptomCount == 0) {
          risk = "Safe";
        } else if (rate > 0.75) {
          risk = "High";
        } else if (rate > 0.25) {
          risk = "Medium";
        } else {
          risk = "Low";
        }

        results.push({
          ingredient,
          symptoms: Array.from(data.symptoms)
            .map((s) => s.charAt(0).toUpperCase() + s.slice(1))
            .join(", "),
          risk,
          symptomRate: rate.toFixed(2), // decimal symptom rate here
        });
      }

      renderTable(results);
    }

    function renderTable(data) {
      const table = document.getElementById("resultsTable");
      const tbody = table.querySelector("tbody");
      tbody.innerHTML = "";

      if (data.length === 0) {
        table.style.display = "none";
        return;
      }

      data.forEach((row) => {
        const tr = document.createElement("tr");
        // symptomRate column is hidden
        tr.innerHTML = `<td>${row.ingredient}</td><td>${row.symptoms}</td><td>${row.risk}</td><td style="display:none;">${row.symptomRate}</td>`;
        tbody.appendChild(tr);
      });

      table.style.display = "table";
    }

    function downloadResults() {
      const rows = document.querySelectorAll("#resultsTable tbody tr");
      if (rows.length === 0) {
        alert("Nothing to download. Run the analysis first.");
        return;
      }

      let csv = "Ingredient,Associated Symptoms,Risk Level,Symptom Rate (Decimal)\n";
      rows.forEach((row) => {
        const cols = row.querySelectorAll("td");
        csv += `${cols[0].textContent},"${cols[1].textContent}",${cols[2].textContent},${cols[3].textContent}\n`;
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "symptom_risk_analysis.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    createSymptomChecklist();
  </script>
</body>
</html>

