<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Food Symptom Tracker</title>
  <style>
    body { font-family: Arial; max-width: 800px; margin: auto; padding: 20px; }
    .page { display: none; }
    .visible { display: block; }
    input, button, select, textarea { width: 100%; font-size: 1rem; padding: 8px; margin: 8px 0; }
    .chip { display: inline-block; background: #eee; padding: 4px 8px; margin: 2px; border-radius: 4px; cursor: pointer;}
    .autocomplete-suggestions { border: 1px solid #ccc; position: absolute; background: white; z-index:1000; max-height:150px; overflow-y:auto; }
    .autocomplete-suggestion { padding: 4px; cursor: pointer; }
    .autocomplete-suggestion:hover { background: #ddd; }
    table { width:100%; border-collapse: collapse; margin-top:20px; }
    th, td { border:1px solid #aaa; padding:8px; text-align:left; }
    .severity { margin-left: 20px; }
    .hidden { display: none; }
    .tag { font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; margin-left: 4px; }
    .safe { background-color: #cce5cc; color: #2e662e; }
    .trigger { background-color: #f8d7da; color: #721c24; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>

<!-- Welcome Screen -->
<div id="welcome" class="page">
  <h2>Welcome to the Food Symptom Tracker!</h2>
  <p>Before we begin, please mark any ingredients you already know are safe or trigger foods.</p>
  <label>Search Ingredient:</label>
  <input type="text" id="welcomeInput" placeholder="Start typing..." autocomplete="off" />
  <div id="welcomeSuggestions" class="autocomplete-suggestions"></div>
  <div id="welcomeChips"></div>
  <button onclick="enterApp()">Start Using App</button>
</div>

<!-- Main Navigation -->
<div id="main" class="page">
  <h1>Food Symptom Tracker</h1>
  <button onclick="showPage('logFood')">Log Food</button>
  <button onclick="showPage('logSymptoms')">Log Symptoms</button>
  <button onclick="exportFoodCSV()">Export Food Log CSV</button>
  <button onclick="exportSymptomCSV()">Export Symptom Log CSV</button>
  <button onclick="showPage('settings')">Settings</button>
</div>

<!-- Log Food Page -->
<div id="logFood" class="page" style="position:relative;">
  <h2>Log Food</h2>
  <label>Enter ingredients (start typing):</label>
  <input type="text" id="ingredientInput" placeholder="e.g. avocado, bread" autocomplete="off" />
  <div id="suggestions" class="autocomplete-suggestions"></div>
  <div id="chips"></div>
  <label>Time eaten:</label>
  <input type="datetime-local" id="foodTime" />
  <button onclick="saveFood()">Save Food</button>
  <button onclick="showPage('main')">Back</button>
</div>

<!-- Log Symptoms Page -->
<div id="logSymptoms" class="page">
  <h2>Log Symptoms</h2>
  <label for="symptomTime">Time symptoms started:</label>
  <input type="datetime-local" id="symptomTime" />
  <div id="symptomContainer"></div>
  <button onclick="saveSymptoms()">Save Symptoms</button>
  <button onclick="showPage('main')">Back</button>
</div>

<!-- Settings Page -->
<div id="settings" class="page">
  <h2>Safe & Trigger Foods</h2>
  <h3>Safe Foods</h3>
  <ul id="safeList"></ul>
  <h3>Trigger Foods</h3>
  <ul id="triggerList"></ul>
  <button onclick="clearData()">Clear All Data</button>
  <button onclick="showPage('main')">Back</button>
</div>

<script>
let ingredientList = [], selectedIngredients = [], selectedWelcomeIngredients = [];
let safeFoods = [], triggerFoods = [];

// Load ingredients from CSV
async function loadIngredients() {
  try {
    const response = await fetch('ingredients.csv');
    const csvText = await response.text();
    const results = Papa.parse(csvText, { header: true, skipEmptyLines: true });
    ingredientList = results.data.map(row => row.Description?.toLowerCase()).filter(Boolean);
    setupWelcomeAutocomplete();
    setupMainAutocomplete();
  } catch (error) {
    alert("Error loading ingredient list.");
  }
}
loadIngredients();

// Show a page
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('visible'));
  document.getElementById(id).classList.add('visible');
  if (id === "settings") loadSettings();
}

// Save onboarding choices
function enterApp() {
  localStorage.setItem("safeFoods", JSON.stringify(safeFoods));
  localStorage.setItem("triggerFoods", JSON.stringify(triggerFoods));
  localStorage.setItem("welcomeCompleted", "true");
  showPage("main");
}

// Autocomplete for welcome screen
function setupWelcomeAutocomplete() {
  const input = document.getElementById("welcomeInput");
  const suggestions = document.getElementById("welcomeSuggestions");
  const chips = document.getElementById("welcomeChips");

  input.addEventListener("input", () => {
    const val = input.value.toLowerCase().trim();
    suggestions.innerHTML = "";
    if (!val) return;
    ingredientList.filter(i => i.includes(val)).slice(0, 10).forEach(m => {
      const div = document.createElement("div");
      div.className = "autocomplete-suggestion";
      div.textContent = m;
      div.onclick = () => {
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.textContent = m;
        const safeBtn = document.createElement("button");
        safeBtn.textContent = "Safe";
        safeBtn.onclick = () => {
          if (!safeFoods.includes(m)) safeFoods.push(m);
          chip.remove();
        };
        const triggerBtn = document.createElement("button");
        triggerBtn.textContent = "Trigger";
        triggerBtn.onclick = () => {
          if (!triggerFoods.includes(m)) triggerFoods.push(m);
          chip.remove();
        };
        chip.append(" ", safeBtn, triggerBtn);
        chips.appendChild(chip);
        input.value = "";
        suggestions.innerHTML = "";
      };
      suggestions.appendChild(div);
    });
  });
}

// Autocomplete for food logging
function setupMainAutocomplete() {
  const input = document.getElementById("ingredientInput");
  const suggestions = document.getElementById("suggestions");
  const chips = document.getElementById("chips");

  input.addEventListener("input", () => {
    const val = input.value.toLowerCase().split(/, */).pop().trim();
    suggestions.innerHTML = "";
    if (!val || !ingredientList.length) return;
    const matches = ingredientList.filter(i => i.includes(val)).slice(0, 10);
    matches.forEach(m => {
      const div = document.createElement("div");
      div.className = "autocomplete-suggestion";
      div.textContent = m;
      div.onclick = () => {
        if (!selectedIngredients.includes(m)) {
          selectedIngredients.push(m);
          const chip = document.createElement("span");
          chip.className = "chip";
          chip.textContent = m;
          chip.onclick = () => {
            selectedIngredients = selectedIngredients.filter(x => x !== m);
            chip.remove();
          };
          chips.appendChild(chip);
        }
        input.value = "";
        suggestions.innerHTML = "";
      };
      suggestions.appendChild(div);
    });
  });
}

// Save food log
function saveFood() {
  const time = document.getElementById("foodTime").value;
  if (!selectedIngredients.length || !time) return alert("Add ingredients and time.");
  const logs = JSON.parse(localStorage.getItem("foodLogs") || "[]");
  logs.push({ ingredients: selectedIngredients.slice(), time });
  localStorage.setItem("foodLogs", JSON.stringify(logs));
  selectedIngredients = [];
  document.getElementById("chips").innerHTML = "";
  document.getElementById("foodTime").value = "";
  alert("Food saved.");
  showPage("main");
}

// Render symptom sliders
const symptomsList = ["Abdominal pain", "Diarrhea", "Fatigue", "Bloating", "Joint pain", "Mouth sores", "Fever", "Constipation", "Nausea"];
const container = document.getElementById("symptomContainer");
function renderSymptoms() {
  container.innerHTML = "";
  symptomsList.forEach(sym => {
    const wrapper = document.createElement("div");
    const cb = document.createElement("input");
    cb.type = "checkbox"; cb.id = `chk-${sym}`;
    const lb = document.createElement("label");
    lb.htmlFor = cb.id; lb.textContent = ` ${sym}`;
    const severityDiv = document.createElement("div");
    severityDiv.className = "severity hidden";
    const slider = document.createElement("input");
    slider.type = "range"; slider.min = 0; slider.max = 5; slider.value = 0;
    const out = document.createElement("span");
    out.textContent = "0";
    slider.oninput = () => out.textContent = slider.value;
    severityDiv.append("Severity: ", slider, out);
    cb.onchange = () => severityDiv.classList.toggle("hidden", !cb.checked);
    wrapper.append(cb, lb, severityDiv);
    container.appendChild(wrapper);
  });
}
renderSymptoms();

// Save symptom log
function saveSymptoms() {
  const time = document.getElementById("symptomTime").value;
  if (!time) return alert("Enter symptom time.");
  const selected = [];
  symptomsList.forEach(sym => {
    const cb = document.getElementById(`chk-${sym}`);
    if (cb.checked) {
      const slider = cb.parentNode.querySelector("input[type=range]");
      selected.push({ symptom: sym, severity: parseInt(slider.value) });
    }
  });
  if (!selected.length) return alert("Select symptoms.");
  const logs = JSON.parse(localStorage.getItem("symptomLogs") || "[]");
  logs.push({ time, symptoms: selected });
  localStorage.setItem("symptomLogs", JSON.stringify(logs));
  document.getElementById("symptomTime").value = "";
  renderSymptoms();
  alert("Symptoms saved.");
  showPage("main");
}

// Load settings page
function loadSettings() {
  const safe = JSON.parse(localStorage.getItem("safeFoods") || "[]");
  const trigger = JSON.parse(localStorage.getItem("triggerFoods") || "[]");
  const safeList = document.getElementById("safeList");
  const triggerList = document.getElementById("triggerList");
  safeList.innerHTML = triggerList.innerHTML = "";
  safe.forEach(f => {
    const li = document.createElement("li");
    li.textContent = f;
    safeList.appendChild(li);
  });
  trigger.forEach(f => {
    const li = document.createElement("li");
    li.textContent = f;
    triggerList.appendChild(li);
  });
}

// Clear all data
function clearData() {
  if (confirm("Are you sure you want to clear ALL local data?")) {
    localStorage.clear();
    location.reload();
  }
}

// On load: check if user finished welcome
window.addEventListener("load", () => {
  const welcomeCompleted = localStorage.getItem("welcomeCompleted");
  if (welcomeCompleted === "true") {
    showPage("main");
  } else {
    showPage("welcome");
  }
});

// Export Food CSV
async function exportFoodCSV() {
  const foodLogs = JSON.parse(localStorage.getItem("foodLogs") || "[]");
  if (!foodLogs.length) return alert("No food logs to export.");

  try {
    const response = await fetch('ingredients.csv');
    const csvText = await response.text();
    const results = Papa.parse(csvText, { header: true, skipEmptyLines: true });
    const ingredientsMap = {};
    results.data.forEach(row => {
      const desc = row.Description?.toLowerCase();
      if (desc) ingredientsMap[desc] = row;
    });

    const headers = ["Time", ...Object.keys(results.data[0])];
    const rows = [headers];

    foodLogs.forEach(entry => {
      entry.ingredients.forEach(ing => {
        const data = ingredientsMap[ing.toLowerCase()];
        if (data) {
          const row = [entry.time, ...headers.slice(1).map(h => data[h] || "")];
          rows.push(row);
        }
      });
    });

    const csv = rows.map(r => r.map(x => `"${x}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "food_log.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  } catch (error) {
    alert("Error exporting food log.");
    console.error(error);
  }
}

// Export Symptom CSV
function exportSymptomCSV() {
  const symptomLogs = JSON.parse(localStorage.getItem("symptomLogs") || "[]");
  if (!symptomLogs.length) return alert("No symptom logs to export.");

  const rows = [["Time", "Symptom", "Severity"]];
  symptomLogs.forEach(entry => {
    entry.symptoms.forEach(sym => {
      rows.push([entry.time, sym.symptom, sym.severity]);
    });
  });

  const csv = rows.map(r => r.map(x => `"${x}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "symptom_log.csv";
  a.click();
  URL.revokeObjectURL(a.href);
}
</script>

</body>
</html>
