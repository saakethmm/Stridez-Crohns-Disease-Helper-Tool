<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crohn's Food Log</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    input, textarea, button, select {
      font-size: 1rem;
      padding: 6px;
      margin: 4px 0;
    }
    .page {
      display: none;
    }
    .visible {
      display: block;
    }
    .home-buttons {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 20px;
    }
    .autocomplete-suggestions {
      border: 1px solid #ccc;
      max-height: 150px;
      overflow-y: auto;
      background: white;
      position: absolute;
      z-index: 10;
      width: calc(100% - 12px);
    }
    .autocomplete-suggestion {
      padding: 5px;
      cursor: pointer;
    }
    .autocomplete-suggestion:hover {
      background-color: #eee;
    }
    .chip {
      display: inline-block;
      padding: 5px 10px;
      margin: 4px;
      background: #d4f0ff;
      border-radius: 12px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="main" class="page visible">
    <h1>Food Symptom Tracker</h1>
    <div class="home-buttons">
      <button onclick="showPage('logFood')">Log Food</button>
      <button onclick="showPage('logWater')">Track Water</button>
      <button onclick="showPage('logSymptoms')">Log Symptoms</button>
      <button onclick="showPage('pastLogs')">View Logs</button>
    </div>
    <h2>Daily Summary</h2>
    <p><strong>Water Intake:</strong> <span id="waterSummary">0 oz</span></p>
    <p><strong>Total Fiber:</strong> <span id="fiberSummary">0 g</span></p>
    <p><strong>Saturated Fat:</strong> <span id="fatSummary">0 g</span></p>
  </div>

  <div id="logFood" class="page">
    <h2>Log Food</h2>
    <label>Enter ingredients:</label>
    <input type="text" id="ingredientInput" placeholder="e.g. bread" autocomplete="off" />
    <div id="chips"></div>
    <label>Time eaten:</label>
    <input type="datetime-local" id="foodTime" />
    <button onclick="saveFood()">Save Food</button>
    <button onclick="showPage('main')">Back</button>
  </div>

  <div id="logWater" class="page">
    <h2>Track Water Intake</h2>
    <label for="waterAmount">Amount (oz):</label>
    <input type="number" id="waterAmount" placeholder="e.g. 8" min="1" />
    <label for="waterTime">Time consumed:</label>
    <input type="datetime-local" id="waterTime" />
    <button onclick="saveWater()">Save Water</button>
    <button onclick="showPage('main')">Back</button>
  </div>

  <div id="logSymptoms" class="page">
    <h2>Log Symptoms</h2>
    <label>Symptom(s):</label>
    <input type="text" id="symptomInput" />
    <label>Time observed:</label>
    <input type="datetime-local" id="symptomTime" />
    <button onclick="saveSymptom()">Save Symptom</button>
    <button onclick="showPage('main')">Back</button>
  </div>

  <div id="pastLogs" class="page">
    <h2>Past Logs</h2>
    <pre id="logOutput"></pre>
    <button onclick="showPage('main')">Back</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    let csvData = [], ingredientList = [], selectedIngredients = [];

    async function loadCSVOnce() {
      const cached = localStorage.getItem("ingredientsCSV");
      if (cached) {
        parseCSV(cached);
        return;
      }
      try {
        const res = await fetch("ingredients.csv");
        const text = await res.text();
        localStorage.setItem("ingredientsCSV", text);
        parseCSV(text);
      } catch (err) {
        alert("Couldn't load ingredients.csv â€” make sure it's in your Live Server root.");
      }
    }

    function parseCSV(text) {
      const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
      csvData = parsed.data;
      ingredientList = csvData.map(row => row.Description?.toLowerCase()).filter(Boolean);
    }

    function showPage(id) {
      document.querySelectorAll(".page").forEach(p => p.classList.remove("visible"));
      document.getElementById(id).classList.add("visible");
      if (id === "pastLogs") showLogs();
      if (id === "main") updateSummary();
    }

    const ingredientInput = document.getElementById("ingredientInput");
    const suggestionsHost = document.getElementById("suggestions");
    const chipsHost = document.getElementById("chips");

    ingredientInput.addEventListener("input", () => {
      const text = ingredientInput.value.toLowerCase().split(/, */).pop().trim();
      suggestionsHost.innerHTML = "";
      if (!text || ingredientList.length === 0) return;
      const matches = ingredientList.filter(i => i.startsWith(text)).slice(0, 10);
      matches.forEach(match => {
        const div = document.createElement("div");
        div.className = "autocomplete-suggestion";
        div.textContent = match;
        div.onclick = () => selectIngredient(match);
        suggestionsHost.appendChild(div);
      });
    });

    function selectIngredient(ing) {
      if (!selectedIngredients.includes(ing)) {
        selectedIngredients.push(ing);
        const chip = document.createElement("span");
        chip.className = "chip";
        chip.textContent = ing;
        chip.onclick = () => {
          selectedIngredients = selectedIngredients.filter(i => i !== ing);
          chip.remove();
        };
        chipsHost.appendChild(chip);
      }
      ingredientInput.value = "";
      suggestionsHost.innerHTML = "";
    }

    function saveFood() {
      const time = document.getElementById("foodTime").value;
      if (!selectedIngredients.length || !time) {
        return alert("Please select food and time.");
      }
      const logs = JSON.parse(localStorage.getItem("foodLogs") || "[]");
      logs.push({ food: selectedIngredients.join(", "), time });
      localStorage.setItem("foodLogs", JSON.stringify(logs));
      selectedIngredients = [];
      chipsHost.innerHTML = "";
      document.getElementById("foodTime").value = "";
      updateSummary();
      showPage("main");
    }

    function saveWater() {
      const amount = parseFloat(document.getElementById("waterAmount").value);
      const time = document.getElementById("waterTime").value;
      if (!amount || !time) return alert("Enter both amount and time.");
      const logs = JSON.parse(localStorage.getItem("waterLogs") || "[]");
      logs.push({ amount, time });
      localStorage.setItem("waterLogs", JSON.stringify(logs));
      document.getElementById("waterAmount").value = "";
      document.getElementById("waterTime").value = "";
      updateSummary();
      showPage("main");
    }

    function saveSymptom() {
      const symptom = document.getElementById("symptomInput").value.trim();
      const time = document.getElementById("symptomTime").value;
      if (!symptom || !time) return alert("Enter both symptom and time.");
      const logs = JSON.parse(localStorage.getItem("symptomLogs") || "[]");
      logs.push({ symptom, time });
      localStorage.setItem("symptomLogs", JSON.stringify(logs));
      document.getElementById("symptomInput").value = "";
      document.getElementById("symptomTime").value = "";
      showPage("main");
    }

    function showLogs() {
      const foodLogs = JSON.parse(localStorage.getItem("foodLogs") || "[]");
      const waterLogs = JSON.parse(localStorage.getItem("waterLogs") || "[]");
      const symptomLogs = JSON.parse(localStorage.getItem("symptomLogs") || "[]");
      let logText = "Food Logs:\n";
      foodLogs.forEach(log => logText += `- ${log.food} at ${log.time}\n`);
      logText += "\nWater Logs:\n";
      waterLogs.forEach(log => logText += `- ${log.amount} oz at ${log.time}\n`);
      logText += "\nSymptom Logs:\n";
      symptomLogs.forEach(log => logText += `- ${log.symptom} at ${log.time}\n`);
      document.getElementById("logOutput").textContent = logText;
    }

    function updateSummary() {
      const foodLogs = JSON.parse(localStorage.getItem("foodLogs") || "[]");
      const waterLogs = JSON.parse(localStorage.getItem("waterLogs") || "[]");

      // Water
      const totalWater = waterLogs.reduce((sum, log) => sum + (parseFloat(log.amount) || 0), 0);
      document.getElementById("waterSummary").textContent = `${totalWater.toFixed(1)} oz`;

      // Fiber and Fat
      let fiber = 0, satFat = 0;
      for (const log of foodLogs) {
        const ingredients = log.food.split(",").map(f => f.trim().toLowerCase());
        for (const ing of ingredients) {
          const row = csvData.find(r => r.Description?.toLowerCase() === ing);
          if (row) {
            fiber += parseFloat(row["Data.Fiber"]) || 0;
            satFat += parseFloat(row["Data.Fat.Saturated Fat"]) || 0;
          }
        }
      }
      document.getElementById("fiberSummary").textContent = `${fiber.toFixed(1)} g`;
      document.getElementById("fatSummary").textContent = `${satFat.toFixed(1)} g`;
    }

    document.addEventListener("DOMContentLoaded", loadCSVOnce);
  </script>
</body>
</html>
