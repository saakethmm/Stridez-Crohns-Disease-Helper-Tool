<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tracker with Ingredient Autocomplete & CSV Fetch</title>
  <style>
    body { font-family: Arial; max-width: 700px; margin: auto; padding: 20px; }
    .page { display: none; }
    .visible { display: block; }
    input, button, select, textarea { width: 100%; font-size: 1rem; padding: 8px; margin: 8px 0; }
    .chip { display: inline-block; background: #eee; padding: 4px 8px; margin: 2px; border-radius: 4px; cursor: pointer;}
    .autocomplete-suggestions { border: 1px solid #ccc; position: absolute; background: white; z-index:1000; max-height:150px; overflow-y:auto; }
    .autocomplete-suggestion { padding: 4px; cursor: pointer; }
    .autocomplete-suggestion:hover { background: #ddd; }
    table { width:100%; border-collapse: collapse; margin-top:20px; }
    th, td { border:1px solid #aaa; padding:8px; text-align:left; }
    .severity { margin-left: 20px; }
    .hidden { display: none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>

  <div id="main" class="page visible">
    <h1>Food Symptom Tracker</h1>
    <button onclick="showPage('logFood')">Log Food</button>
    <button onclick="showPage('logSymptoms')">Log Symptoms</button>
    <button onclick="showPage('pastLogs')">View Logs</button>
  </div>

  <div id="logFood" class="page" style="position:relative;">
    <h2>Log Food</h2>
    <label>Enter ingredients (start typing):</label>
    <input type="text" id="ingredientInput" placeholder="e.g. avocado, bread" autocomplete="off" />
    <div id="suggestions" class="autocomplete-suggestions"></div>
    <div id="chips"></div>
    <label>Time eaten:</label>
    <input type="datetime-local" id="foodTime" />
    <button onclick="saveFood()">Save Food</button>
    <button onclick="showPage('main')">Back</button>
  </div>

  <div id="logSymptoms" class="page">
    <h2>Log Symptoms</h2>
    <label for="symptomTime">Time symptoms started:</label>
    <input type="datetime-local" id="symptomTime" />
    <div id="symptomContainer"></div>
    <button onclick="saveSymptoms()">Save Symptoms</button>
    <button onclick="showPage('main')">Back</button>
  </div>

  <div id="pastLogs" class="page">
    <h2>Past Logs & Risk Analysis</h2>
    <button onclick="showPage('main')">Back</button>
    <button onclick="exportCSV()">Export CSV</button>
    <table id="logTable">
      <tr><th>Food</th><th>Risk Score</th></tr>
    </table>
  </div>

<script>
  let ingredientList = [];

  async function loadIngredients() {
    try {
      const response = await fetch('ingredients.csv');
      const csvText = await response.text();
      const results = Papa.parse(csvText, { header: true, skipEmptyLines: true });
      ingredientList = results.data.map(row => row.Description?.toLowerCase()).filter(Boolean);
      console.log("Loaded ingredients:", ingredientList.length);
    } catch (error) {
      console.error("Error loading CSV:", error);
      alert("Failed to load ingredient list. Make sure ingredients.csv is accessible.");
    }
  }

  loadIngredients();

  const ingredientInput = document.getElementById("ingredientInput");
  const suggestionsHost = document.getElementById("suggestions");
  const chipsHost = document.getElementById("chips");
  let selectedIngredients = [];

  ingredientInput.addEventListener("input", () => {
    const text = ingredientInput.value.toLowerCase().split(/, */).pop().trim();
    suggestionsHost.innerHTML = "";
    if (!text || ingredientList.length === 0) return;
    const matches = ingredientList.filter(i => i.startsWith(text)).slice(0, 10);
    matches.forEach(m => {
      const div = document.createElement("div");
      div.className = "autocomplete-suggestion";
      div.textContent = m;
      div.onclick = () => selectIngredient(m);
      suggestionsHost.appendChild(div);
    });
  });

  function selectIngredient(ing) {
    if (!selectedIngredients.includes(ing)) {
      selectedIngredients.push(ing);
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.textContent = ing;
      chip.title = "Click to remove";
      chip.onclick = () => {
        selectedIngredients = selectedIngredients.filter(x => x !== ing);
        chip.remove();
      };
      chipsHost.appendChild(chip);
    }
    ingredientInput.value = "";
    suggestionsHost.innerHTML = "";
  }

  function saveFood() {
    const time = document.getElementById("foodTime").value;
    if (selectedIngredients.length === 0 || !time) return alert("Add ingredients and time.");
    const logs = JSON.parse(localStorage.getItem("foodLogs") || "[]");
    logs.push({ ingredients: selectedIngredients.slice(), time });
    localStorage.setItem("foodLogs", JSON.stringify(logs));
    selectedIngredients = [];
    chipsHost.innerHTML = "";
    document.getElementById("foodTime").value = "";
    alert("Food saved.");
    showPage('main');
  }

  const symptomsList = [
    "Abdominal pain", "Diarrhea", "Fatigue", "Bloating", "Joint pain", "Mouth sores", "Fever", "Constipation", "Nausea"
  ];
  const container = document.getElementById("symptomContainer");

  function renderSymptoms() {
    container.innerHTML = "";
    symptomsList.forEach(sym => {
      const wrapper = document.createElement("div");
      wrapper.classList.add("symptom");

      const cb = document.createElement("input");
      cb.type = "checkbox"; cb.id = `chk-${sym}`;

      const lb = document.createElement("label");
      lb.htmlFor = cb.id; lb.textContent = ` ${sym}`;

      const severityDiv = document.createElement("div");
      severityDiv.className = "severity hidden";

      const slider = document.createElement("input");
      slider.type = "range"; slider.min = 0; slider.max = 5; slider.value = 0;

      const out = document.createElement("span");
      out.textContent = "0";

      slider.oninput = () => out.textContent = slider.value;

      severityDiv.append("Severity: ", slider, out);

      cb.onchange = () => severityDiv.classList.toggle("hidden", !cb.checked);

      wrapper.append(cb, lb, severityDiv);
      container.appendChild(wrapper);
    });
  }
  renderSymptoms();

  function saveSymptoms() {
    const time = document.getElementById("symptomTime").value;
    if (!time) return alert("Enter symptom time");
    const selected = [];
    symptomsList.forEach(sym => {
      const cb = document.getElementById(`chk-${sym}`);
      const slider = document.querySelector(`#chk-${sym} ~ .severity input`);
      if (cb.checked) selected.push({ symptom: sym, severity: parseInt(slider.value) });
    });
    if (!selected.length) return alert("Select symptoms");
    const logs = JSON.parse(localStorage.getItem("symptomLogs") || "[]");
    logs.push({ time, symptoms: selected });
    localStorage.setItem("symptomLogs", JSON.stringify(logs));
    document.getElementById("symptomTime").value = "";
    document.querySelectorAll(".severity input").forEach(i => i.value = 0);
    showPage('main');
    alert("Symptoms saved.");
  }

  function getRiskData() {
    const foods = JSON.parse(localStorage.getItem("foodLogs") || "[]");
    const symptoms = JSON.parse(localStorage.getItem("symptomLogs") || "[]");
    const foodRisk = {};
    symptoms.forEach(sym => {
      const st = new Date(sym.time).getTime();
      foods.forEach(f => {
        const ft = new Date(f.time).getTime();
        const delta = (st - ft) / (1000 * 60 * 60);
        if (delta >= 0 && delta <= 6) {
          const weight = 1 - delta / 6;
          const sum = sym.symptoms.reduce((a, s) => a + s.severity, 0);
          f.ingredients.forEach(ing => {
            foodRisk[ing] = (foodRisk[ing] || 0) + weight * sum;
          });
        }
      });
    });
    return foodRisk;
  }

  function loadPastLogs() {
    const foodRisk = getRiskData();
    const table = document.getElementById("logTable");
    table.innerHTML = "<tr><th>Food</th><th>Risk Score</th></tr>";
    const arr = Object.entries(foodRisk).sort((a, b) => b[1] - a[1]);
    if (!arr.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 2;
      td.textContent = "No correlations";
      tr.append(td);
      table.append(tr);
    } else arr.forEach(([f, r]) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${f}</td><td>${r.toFixed(2)}</td>`;
      table.append(tr);
    });
  }

  function exportCSV() {
    const data = getRiskData();
    const rows = [["Food", "Risk Score"], ...Object.entries(data).map(([f, r]) => [f, r.toFixed(2)])];
    const txt = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob([txt], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "food_risk.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  function showPage(id) {
    document.querySelectorAll(".page").forEach(p => p.classList.remove("visible"));
    document.getElementById(id).classList.add("visible");
    if (id === "pastLogs") loadPastLogs();
  }
</script>

</body>
</html>
